import numpy as np
import struct
import logging
from vimgextractor.load_vegas import VEGASStatus 
import ROOT

logger = logging.getLogger(__name__)

# Load VEGAS functions 
# Depricated
#root_load_code = ROOT.gSystem.Load("$VEGAS/common/lib/libSP24sharedLite.so")

class VARootFile:
    def __init__(self,f):
        self.vegas_status = VEGASStatus()
        self.vegas_status.loadVEGAS()
        self.__root_file__ = ROOT.VARootIO(f, 1)

    def get_array_info(self):
        array_info = self.__root_file__.loadTheArrayInfo()
        telescopes = array_info.telescopes()
        tels_info  = [ telescopes.at(i) for i in range(telescopes.size())]
        
        out = dict()
        for tel in tels_info:
            tel_dict = dict()
            tel_dict['tel_id'] = tel.id()
            tel_dict['tel_x']  = tel.positionEastM()
            tel_dict['tel_y']  = tel.positionNorthM()
            tel_dict['tel_z']  = tel.positionUD()
            tel_dict['tel_type'] = 'VTS'
            # What is it ? some CTA specific stuff
            tel_dict['run_array_direction'] = np.array([0,0])
            out[tel.id()+1] = tel_dict
        return out            

    def __get_triggered_tel__(self,triggeredTels):
        tt = []
        for i in range(triggeredTels.size()):
            b = struct.unpack("1B",triggeredTels[i].encode())[0]
            if(b == 1):
                tt.append(i+1)
        return tt     
    
    def __get_matched_SimEvtList__(self,sim,cal,evtlist):
        logger.debug('Start building matched simulation events list')
        # Get all the calibrated event numbers
        calibEvtData = ROOT.VACalibratedArrayEvent()
        cal.SetBranchAddress("C", calibEvtData)
        arrevt  = []
        for i in evtlist:
            cal.GetEntry(i)
            arrevt.append(calibEvtData.fArrayEventNum) 

        # Find matched simulations
        sd = ROOT.VASimulationData()
        sim.SetBranchAddress("Sim",sd)
        elist = ROOT.TEventList()
        sorted_arrevt = list(np.sort(arrevt))
        evt = sorted_arrevt.pop(0)
        for i in range(sim.GetEntries()):
            sim.GetEntry(i)
            if( sd.fArrayEventNum == evt):
                elist.Enter(i)
                try:
                    evt = sorted_arrevt.pop(0)
                except IndexError:
                    break        
        logger.debug('Done building matched simulation events list')
        return elist    


    def read_st2_calib_channel_charge(self, tels=[0,1,2,3], maskL2=True, 
                              l2channels=[[110, 249, 255, 404, 475, 499], [128, 173, 259, 498, 499], [37, 159, 319, 451, 499], [99, 214, 333, 499]],
                              start_event=None, stop_event=None, evtlist=None,cleaning={'img':5.0,'brd':2.5}):
        calibTree = self.__root_file__.loadTheCalibratedEventTree()
        if start_event is None:
            start_event = 0
        if stop_event  is None:
            stop_event  = calibTree.GetEntries() -1 + start_event
    
        if evtlist is None:
            assert (start_event < stop_event), "Please specify sensible start_event and stop_event numbers. "
            totalEvtNum = stop_event + 1 - start_event
            evtlist = range(start_event, stop_event+1)
        else:
            totalEvtNum = len(evtlist)
    
        logger.debug("Will get charge from {:d} events.".format(totalEvtNum))
        
        try:
            allCharge = np.zeros((4, 500))
            allTZero  = np.zeros((4, 500))
        except MemoryError:
            logger.error("Large number of events caused a MemoryError... "
                  "Let's try passing start_event and stop_event or evtlist to analyze a smaller set of events.")
            raise
    
        if maskL2:
            #hard-coded for speed, all numbers are CHANNEL IDs
            neighbor_dict = {0: [1, 2, 3, 4, 5, 6],
                         1: [0, 2, 6, 7, 8, 18],
                         2: [0, 1, 3, 8, 9, 10],
                         3: [0, 2, 4, 10, 11, 12],
                         4: [0, 3, 5, 12, 13, 14],
                         5: [0, 4, 6, 14, 15, 16],
                         6: [0, 1, 5, 16, 17, 18],
                         7: [1, 8, 18, 19, 20, 36],
                         8: [1, 2, 7, 9, 20, 21],
                         9: [2, 8, 10, 21, 22, 23],
                         10: [2, 3, 9, 11, 23, 24],
                         11: [3, 10, 12, 24, 25, 26],
                         12: [3, 4, 11, 13, 26, 27],
                         13: [4, 12, 14, 27, 28, 29],
                         14: [4, 5, 13, 15, 29, 30],
                         15: [5, 14, 16, 30, 31, 32],
                         16: [5, 6, 15, 17, 32, 33],
                         17: [6, 16, 18, 33, 34, 35],
                         18: [1, 6, 7, 17, 35, 36],
                         19: [7, 20, 36, 37, 38, 60],
                         20: [7, 8, 19, 21, 38, 39],
                         21: [8, 9, 20, 22, 39, 40],
                         22: [9, 21, 23, 40, 41, 42],
                         23: [9, 10, 22, 24, 42, 43],
                         24: [10, 11, 23, 25, 43, 44],
                         25: [11, 24, 26, 44, 45, 46],
                         26: [11, 12, 25, 27, 46, 47],
                         27: [12, 13, 26, 28, 47, 48],
                         28: [13, 27, 29, 48, 49, 50],
                         29: [13, 14, 28, 30, 50, 51],
                         30: [14, 15, 29, 31, 51, 52],
                         31: [15, 30, 32, 52, 53, 54],
                         32: [15, 16, 31, 33, 54, 55],
                         33: [16, 17, 32, 34, 55, 56],
                         34: [17, 33, 35, 56, 57, 58],
                         35: [17, 18, 34, 36, 58, 59],
                         36: [7, 18, 19, 35, 59, 60],
                         37: [19, 38, 60, 61, 62, 90],
                         38: [19, 20, 37, 39, 62, 63],
                         39: [20, 21, 38, 40, 63, 64],
                         40: [21, 22, 39, 41, 64, 65],
                         41: [22, 40, 42, 65, 66, 67],
                         42: [22, 23, 41, 43, 67, 68],
                         43: [23, 24, 42, 44, 68, 69],
                         44: [24, 25, 43, 45, 69, 70],
                         45: [25, 44, 46, 70, 71, 72],
                         46: [25, 26, 45, 47, 72, 73],
                         47: [26, 27, 46, 48, 73, 74],
                         48: [27, 28, 47, 49, 74, 75],
                         49: [28, 48, 50, 75, 76, 77],
                         50: [28, 29, 49, 51, 77, 78],
                         51: [29, 30, 50, 52, 78, 79],
                         52: [30, 31, 51, 53, 79, 80],
                         53: [31, 52, 54, 80, 81, 82],
                         54: [31, 32, 53, 55, 82, 83],
                         55: [32, 33, 54, 56, 83, 84],
                         56: [33, 34, 55, 57, 84, 85],
                         57: [34, 56, 58, 85, 86, 87],
                         58: [34, 35, 57, 59, 87, 88],
                         59: [35, 36, 58, 60, 88, 89],
                         60: [19, 36, 37, 59, 89, 90],
                         61: [37, 62, 90, 91, 92, 126],
                         62: [37, 38, 61, 63, 92, 93],
                         63: [38, 39, 62, 64, 93, 94],
                         64: [39, 40, 63, 65, 94, 95],
                         65: [40, 41, 64, 66, 95, 96],
                         66: [41, 65, 67, 96, 97, 98],
                         67: [41, 42, 66, 68, 98, 99],
                         68: [42, 43, 67, 69, 99, 100],
                         69: [43, 44, 68, 70, 100, 101],
                         70: [44, 45, 69, 71, 101, 102],
                         71: [45, 70, 72, 102, 103, 104],
                         72: [45, 46, 71, 73, 104, 105],
                         73: [46, 47, 72, 74, 105, 106],
                         74: [47, 48, 73, 75, 106, 107],
                         75: [48, 49, 74, 76, 107, 108],
                         76: [49, 75, 77, 108, 109, 110],
                         77: [49, 50, 76, 78, 110, 111],
                         78: [50, 51, 77, 79, 111, 112],
                         79: [51, 52, 78, 80, 112, 113],
                         80: [52, 53, 79, 81, 113, 114],
                         81: [53, 80, 82, 114, 115, 116],
                         82: [53, 54, 81, 83, 116, 117],
                         83: [54, 55, 82, 84, 117, 118],
                         84: [55, 56, 83, 85, 118, 119],
                         85: [56, 57, 84, 86, 119, 120],
                         86: [57, 85, 87, 120, 121, 122],
                         87: [57, 58, 86, 88, 122, 123],
                         88: [58, 59, 87, 89, 123, 124],
                         89: [59, 60, 88, 90, 124, 125],
                         90: [37, 60, 61, 89, 125, 126],
                         91: [61, 92, 126, 127, 128, 168],
                         92: [61, 62, 91, 93, 128, 129],
                         93: [62, 63, 92, 94, 129, 130],
                         94: [63, 64, 93, 95, 130, 131],
                         95: [64, 65, 94, 96, 131, 132],
                         96: [65, 66, 95, 97, 132, 133],
                         97: [66, 96, 98, 133, 134, 135],
                         98: [66, 67, 97, 99, 135, 136],
                         99: [67, 68, 98, 100, 136, 137],
                         100: [68, 69, 99, 101, 137, 138],
                         101: [69, 70, 100, 102, 138, 139],
                         102: [70, 71, 101, 103, 139, 140],
                         103: [71, 102, 104, 140, 141, 142],
                         104: [71, 72, 103, 105, 142, 143],
                         105: [72, 73, 104, 106, 143, 144],
                         106: [73, 74, 105, 107, 144, 145],
                         107: [74, 75, 106, 108, 145, 146],
                         108: [75, 76, 107, 109, 146, 147],
                         109: [76, 108, 110, 147, 148, 149],
                         110: [76, 77, 109, 111, 149, 150],
                         111: [77, 78, 110, 112, 150, 151],
                         112: [78, 79, 111, 113, 151, 152],
                         113: [79, 80, 112, 114, 152, 153],
                         114: [80, 81, 113, 115, 153, 154],
                         115: [81, 114, 116, 154, 155, 156],
                         116: [81, 82, 115, 117, 156, 157],
                         117: [82, 83, 116, 118, 157, 158],
                         118: [83, 84, 117, 119, 158, 159],
                         119: [84, 85, 118, 120, 159, 160],
                         120: [85, 86, 119, 121, 160, 161],
                         121: [86, 120, 122, 161, 162, 163],
                         122: [86, 87, 121, 123, 163, 164],
                         123: [87, 88, 122, 124, 164, 165],
                         124: [88, 89, 123, 125, 165, 166],
                         125: [89, 90, 124, 126, 166, 167],
                         126: [61, 90, 91, 125, 167, 168],
                         127: [91, 128, 168, 169, 170, 216],
                         128: [91, 92, 127, 129, 170, 171],
                         129: [92, 93, 128, 130, 171, 172],
                         130: [93, 94, 129, 131, 172, 173],
                         131: [94, 95, 130, 132, 173, 174],
                         132: [95, 96, 131, 133, 174, 175],
                         133: [96, 97, 132, 134, 175, 176],
                         134: [97, 133, 135, 176, 177, 178],
                         135: [97, 98, 134, 136, 178, 179],
                         136: [98, 99, 135, 137, 179, 180],
                         137: [99, 100, 136, 138, 180, 181],
                         138: [100, 101, 137, 139, 181, 182],
                         139: [101, 102, 138, 140, 182, 183],
                         140: [102, 103, 139, 141, 183, 184],
                         141: [103, 140, 142, 184, 185, 186],
                         142: [103, 104, 141, 143, 186, 187],
                         143: [104, 105, 142, 144, 187, 188],
                         144: [105, 106, 143, 145, 188, 189],
                         145: [106, 107, 144, 146, 189, 190],
                         146: [107, 108, 145, 147, 190, 191],
                         147: [108, 109, 146, 148, 191, 192],
                         148: [109, 147, 149, 192, 193, 194],
                         149: [109, 110, 148, 150, 194, 195],
                         150: [110, 111, 149, 151, 195, 196],
                         151: [111, 112, 150, 152, 196, 197],
                         152: [112, 113, 151, 153, 197, 198],
                         153: [113, 114, 152, 154, 198, 199],
                         154: [114, 115, 153, 155, 199, 200],
                         155: [115, 154, 156, 200, 201, 202],
                         156: [115, 116, 155, 157, 202, 203],
                         157: [116, 117, 156, 158, 203, 204],
                         158: [117, 118, 157, 159, 204, 205],
                         159: [118, 119, 158, 160, 205, 206],
                         160: [119, 120, 159, 161, 206, 207],
                         161: [120, 121, 160, 162, 207, 208],
                         162: [121, 161, 163, 208, 209, 210],
                         163: [121, 122, 162, 164, 210, 211],
                         164: [122, 123, 163, 165, 211, 212],
                         165: [123, 124, 164, 166, 212, 213],
                         166: [124, 125, 165, 167, 213, 214],
                         167: [125, 126, 166, 168, 214, 215],
                         168: [91, 126, 127, 167, 215, 216],
                         169: [127, 170, 216, 217, 218, 270],
                         170: [127, 128, 169, 171, 218, 219],
                         171: [128, 129, 170, 172, 219, 220],
                         172: [129, 130, 171, 173, 220, 221],
                         173: [130, 131, 172, 174, 221, 222],
                         174: [131, 132, 173, 175, 222, 223],
                         175: [132, 133, 174, 176, 223, 224],
                         176: [133, 134, 175, 177, 224, 225],
                         177: [134, 176, 178, 225, 226, 227],
                         178: [134, 135, 177, 179, 227, 228],
                         179: [135, 136, 178, 180, 228, 229],
                         180: [136, 137, 179, 181, 229, 230],
                         181: [137, 138, 180, 182, 230, 231],
                         182: [138, 139, 181, 183, 231, 232],
                         183: [139, 140, 182, 184, 232, 233],
                         184: [140, 141, 183, 185, 233, 234],
                         185: [141, 184, 186, 234, 235, 236],
                         186: [141, 142, 185, 187, 236, 237],
                         187: [142, 143, 186, 188, 237, 238],
                         188: [143, 144, 187, 189, 238, 239],
                         189: [144, 145, 188, 190, 239, 240],
                         190: [145, 146, 189, 191, 240, 241],
                         191: [146, 147, 190, 192, 241, 242],
                         192: [147, 148, 191, 193, 242, 243],
                         193: [148, 192, 194, 243, 244, 245],
                         194: [148, 149, 193, 195, 245, 246],
                         195: [149, 150, 194, 196, 246, 247],
                         196: [150, 151, 195, 197, 247, 248],
                         197: [151, 152, 196, 198, 248, 249],
                         198: [152, 153, 197, 199, 249, 250],
                         199: [153, 154, 198, 200, 250, 251],
                         200: [154, 155, 199, 201, 251, 252],
                         201: [155, 200, 202, 252, 253, 254],
                         202: [155, 156, 201, 203, 254, 255],
                         203: [156, 157, 202, 204, 255, 256],
                         204: [157, 158, 203, 205, 256, 257],
                         205: [158, 159, 204, 206, 257, 258],
                         206: [159, 160, 205, 207, 258, 259],
                         207: [160, 161, 206, 208, 259, 260],
                         208: [161, 162, 207, 209, 260, 261],
                         209: [162, 208, 210, 261, 262, 263],
                         210: [162, 163, 209, 211, 263, 264],
                         211: [163, 164, 210, 212, 264, 265],
                         212: [164, 165, 211, 213, 265, 266],
                         213: [165, 166, 212, 214, 266, 267],
                         214: [166, 167, 213, 215, 267, 268],
                         215: [167, 168, 214, 216, 268, 269],
                         216: [127, 168, 169, 215, 269, 270],
                         217: [169, 218, 270, 271, 272, 330],
                         218: [169, 170, 217, 219, 272, 273],
                         219: [170, 171, 218, 220, 273, 274],
                         220: [171, 172, 219, 221, 274, 275],
                         221: [172, 173, 220, 222, 275, 276],
                         222: [173, 174, 221, 223, 276, 277],
                         223: [174, 175, 222, 224, 277, 278],
                         224: [175, 176, 223, 225, 278, 279],
                         225: [176, 177, 224, 226, 279, 280],
                         226: [177, 225, 227, 280, 281, 282],
                         227: [177, 178, 226, 228, 282, 283],
                         228: [178, 179, 227, 229, 283, 284],
                         229: [179, 180, 228, 230, 284, 285],
                         230: [180, 181, 229, 231, 285, 286],
                         231: [181, 182, 230, 232, 286, 287],
                         232: [182, 183, 231, 233, 287, 288],
                         233: [183, 184, 232, 234, 288, 289],
                         234: [184, 185, 233, 235, 289, 290],
                         235: [185, 234, 236, 290, 291, 292],
                         236: [185, 186, 235, 237, 292, 293],
                         237: [186, 187, 236, 238, 293, 294],
                         238: [187, 188, 237, 239, 294, 295],
                         239: [188, 189, 238, 240, 295, 296],
                         240: [189, 190, 239, 241, 296, 297],
                         241: [190, 191, 240, 242, 297, 298],
                         242: [191, 192, 241, 243, 298, 299],
                         243: [192, 193, 242, 244, 299, 300],
                         244: [193, 243, 245, 300, 301, 302],
                         245: [193, 194, 244, 246, 302, 303],
                         246: [194, 195, 245, 247, 303, 304],
                         247: [195, 196, 246, 248, 304, 305],
                         248: [196, 197, 247, 249, 305, 306],
                         249: [197, 198, 248, 250, 306, 307],
                         250: [198, 199, 249, 251, 307, 308],
                         251: [199, 200, 250, 252, 308, 309],
                         252: [200, 201, 251, 253, 309, 310],
                         253: [201, 252, 254, 310, 311, 312],
                         254: [201, 202, 253, 255, 312, 313],
                         255: [202, 203, 254, 256, 313, 314],
                         256: [203, 204, 255, 257, 314, 315],
                         257: [204, 205, 256, 258, 315, 316],
                         258: [205, 206, 257, 259, 316, 317],
                         259: [206, 207, 258, 260, 317, 318],
                         260: [207, 208, 259, 261, 318, 319],
                         261: [208, 209, 260, 262, 319, 320],
                         262: [209, 261, 263, 320, 321, 322],
                         263: [209, 210, 262, 264, 322, 323],
                         264: [210, 211, 263, 265, 323, 324],
                         265: [211, 212, 264, 266, 324, 325],
                         266: [212, 213, 265, 267, 325, 326],
                         267: [213, 214, 266, 268, 326, 327],
                         268: [214, 215, 267, 269, 327, 328],
                         269: [215, 216, 268, 270, 328, 329],
                         270: [169, 216, 217, 269, 329, 330],
                         271: [217, 272, 330, 331, 332, 396],
                         272: [217, 218, 271, 273, 332, 333],
                         273: [218, 219, 272, 274, 333, 334],
                         274: [219, 220, 273, 275, 334, 335],
                         275: [220, 221, 274, 276, 335, 336],
                         276: [221, 222, 275, 277, 336, 337],
                         277: [222, 223, 276, 278, 337, 338],
                         278: [223, 224, 277, 279, 338, 339],
                         279: [224, 225, 278, 280, 339, 340],
                         280: [225, 226, 279, 281, 340, 341],
                         281: [226, 280, 282, 341, 342, 343],
                         282: [226, 227, 281, 283, 343, 344],
                         283: [227, 228, 282, 284, 344, 345],
                         284: [228, 229, 283, 285, 345, 346],
                         285: [229, 230, 284, 286, 346, 347],
                         286: [230, 231, 285, 287, 347, 348],
                         287: [231, 232, 286, 288, 348, 349],
                         288: [232, 233, 287, 289, 349, 350],
                         289: [233, 234, 288, 290, 350, 351],
                         290: [234, 235, 289, 291, 351, 352],
                         291: [235, 290, 292, 352, 353, 354],
                         292: [235, 236, 291, 293, 354, 355],
                         293: [236, 237, 292, 294, 355, 356],
                         294: [237, 238, 293, 295, 356, 357],
                         295: [238, 239, 294, 296, 357, 358],
                         296: [239, 240, 295, 297, 358, 359],
                         297: [240, 241, 296, 298, 359, 360],
                         298: [241, 242, 297, 299, 360, 361],
                         299: [242, 243, 298, 300, 361, 362],
                         300: [243, 244, 299, 301, 362, 363],
                         301: [244, 300, 302, 363, 364, 365],
                         302: [244, 245, 301, 303, 365, 366],
                         303: [245, 246, 302, 304, 366, 367],
                         304: [246, 247, 303, 305, 367, 368],
                         305: [247, 248, 304, 306, 368, 369],
                         306: [248, 249, 305, 307, 369, 370],
                         307: [249, 250, 306, 308, 370, 371],
                         308: [250, 251, 307, 309, 371, 372],
                         309: [251, 252, 308, 310, 372, 373],
                         310: [252, 253, 309, 311, 373, 374],
                         311: [253, 310, 312, 374, 375, 376],
                         312: [253, 254, 311, 313, 376, 377],
                         313: [254, 255, 312, 314, 377, 378],
                         314: [255, 256, 313, 315, 378, 379],
                         315: [256, 257, 314, 316, 379, 380],
                         316: [257, 258, 315, 317, 380, 381],
                         317: [258, 259, 316, 318, 381, 382],
                         318: [259, 260, 317, 319, 382, 383],
                         319: [260, 261, 318, 320, 383, 384],
                         320: [261, 262, 319, 321, 384, 385],
                         321: [262, 320, 322, 385, 386, 387],
                         322: [262, 263, 321, 323, 387, 388],
                         323: [263, 264, 322, 324, 388, 389],
                         324: [264, 265, 323, 325, 389, 390],
                         325: [265, 266, 324, 326, 390, 391],
                         326: [266, 267, 325, 327, 391, 392],
                         327: [267, 268, 326, 328, 392, 393],
                         328: [268, 269, 327, 329, 393, 394],
                         329: [269, 270, 328, 330, 394, 395],
                         330: [217, 270, 271, 329, 395, 396],
                         331: [271, 332, 396, 397, 462],
                         332: [271, 272, 331, 333, 397, 398],
                         333: [272, 273, 332, 334, 398, 399],
                         334: [273, 274, 333, 335, 399, 400],
                         335: [274, 275, 334, 336, 400, 401],
                         336: [275, 276, 335, 337, 401, 402],
                         337: [276, 277, 336, 338, 402, 403],
                         338: [277, 278, 337, 339, 403, 404],
                         339: [278, 279, 338, 340, 404, 405],
                         340: [279, 280, 339, 341, 405, 406],
                         341: [280, 281, 340, 342, 406, 407],
                         342: [281, 341, 343, 407, 408],
                         343: [281, 282, 342, 344, 408, 409],
                         344: [282, 283, 343, 345, 409, 410],
                         345: [283, 284, 344, 346, 410, 411],
                         346: [284, 285, 345, 347, 411, 412],
                         347: [285, 286, 346, 348, 412, 413],
                         348: [286, 287, 347, 349, 413, 414],
                         349: [287, 288, 348, 350, 414, 415],
                         350: [288, 289, 349, 351, 415, 416],
                         351: [289, 290, 350, 352, 416, 417],
                         352: [290, 291, 351, 353, 417, 418],
                         353: [291, 352, 354, 418, 419],
                         354: [291, 292, 353, 355, 419, 420],
                         355: [292, 293, 354, 356, 420, 421],
                         356: [293, 294, 355, 357, 421, 422],
                         357: [294, 295, 356, 358, 422, 423],
                         358: [295, 296, 357, 359, 423, 424],
                         359: [296, 297, 358, 360, 424, 425],
                         360: [297, 298, 359, 361, 425, 426],
                         361: [298, 299, 360, 362, 426, 427],
                         362: [299, 300, 361, 363, 427, 428],
                         363: [300, 301, 362, 364, 428, 429],
                         364: [301, 363, 365, 429, 430],
                         365: [301, 302, 364, 366, 430, 431],
                         366: [302, 303, 365, 367, 431, 432],
                         367: [303, 304, 366, 368, 432, 433],
                         368: [304, 305, 367, 369, 433, 434],
                         369: [305, 306, 368, 370, 434, 435],
                         370: [306, 307, 369, 371, 435, 436],
                         371: [307, 308, 370, 372, 436, 437],
                         372: [308, 309, 371, 373, 437, 438],
                         373: [309, 310, 372, 374, 438, 439],
                         374: [310, 311, 373, 375, 439, 440],
                         375: [311, 374, 376, 440, 441],
                         376: [311, 312, 375, 377, 441, 442],
                         377: [312, 313, 376, 378, 442, 443],
                         378: [313, 314, 377, 379, 443, 444],
                         379: [314, 315, 378, 380, 444, 445],
                         380: [315, 316, 379, 381, 445, 446],
                         381: [316, 317, 380, 382, 446, 447],
                         382: [317, 318, 381, 383, 447, 448],
                         383: [318, 319, 382, 384, 448, 449],
                         384: [319, 320, 383, 385, 449, 450],
                         385: [320, 321, 384, 386, 450, 451],
                         386: [321, 385, 387, 451, 452],
                         387: [321, 322, 386, 388, 452, 453],
                         388: [322, 323, 387, 389, 453, 454],
                         389: [323, 324, 388, 390, 454, 455],
                         390: [324, 325, 389, 391, 455, 456],
                         391: [325, 326, 390, 392, 456, 457],
                         392: [326, 327, 391, 393, 457, 458],
                         393: [327, 328, 392, 394, 458, 459],
                         394: [328, 329, 393, 395, 459, 460],
                         395: [329, 330, 394, 396, 460, 461],
                         396: [271, 330, 331, 395, 461, 462],
                         397: [331, 332, 398],
                         398: [332, 333, 397, 399],
                         399: [333, 334, 398, 400, 463],
                         400: [334, 335, 399, 401, 463, 464],
                         401: [335, 336, 400, 402, 464, 465],
                         402: [336, 337, 401, 403, 465, 466],
                         403: [337, 338, 402, 404, 466, 467],
                         404: [338, 339, 403, 405, 467, 468],
                         405: [339, 340, 404, 406, 468],
                         406: [340, 341, 405, 407],
                         407: [341, 342, 406],
                         408: [342, 343, 409],
                         409: [343, 344, 408, 410],
                         410: [344, 345, 409, 411, 469],
                         411: [345, 346, 410, 412, 469, 470],
                         412: [346, 347, 411, 413, 470, 471],
                         413: [347, 348, 412, 414, 471, 472],
                         414: [348, 349, 413, 415, 472, 473],
                         415: [349, 350, 414, 416, 473, 474],
                         416: [350, 351, 415, 417, 474],
                         417: [351, 352, 416, 418],
                         418: [352, 353, 417],
                         419: [353, 354, 420],
                         420: [354, 355, 419, 421],
                         421: [355, 356, 420, 422, 475],
                         422: [356, 357, 421, 423, 475, 476],
                         423: [357, 358, 422, 424, 476, 477],
                         424: [358, 359, 423, 425, 477, 478],
                         425: [359, 360, 424, 426, 478, 479],
                         426: [360, 361, 425, 427, 479, 480],
                         427: [361, 362, 426, 428, 480],
                         428: [362, 363, 427, 429],
                         429: [363, 364, 428],
                         430: [364, 365, 431],
                         431: [365, 366, 430, 432],
                         432: [366, 367, 431, 433, 481],
                         433: [367, 368, 432, 434, 481, 482],
                         434: [368, 369, 433, 435, 482, 483],
                         435: [369, 370, 434, 436, 483, 484],
                         436: [370, 371, 435, 437, 484, 485],
                         437: [371, 372, 436, 438, 485, 486],
                         438: [372, 373, 437, 439, 486],
                         439: [373, 374, 438, 440],
                         440: [374, 375, 439],
                         441: [375, 376, 442],
                         442: [376, 377, 441, 443],
                         443: [377, 378, 442, 444, 487],
                         444: [378, 379, 443, 445, 487, 488],
                         445: [379, 380, 444, 446, 488, 489],
                         446: [380, 381, 445, 447, 489, 490],
                         447: [381, 382, 446, 448, 490, 491],
                         448: [382, 383, 447, 449, 491, 492],
                         449: [383, 384, 448, 450, 492],
                         450: [384, 385, 449, 451],
                         451: [385, 386, 450],
                         452: [386, 387, 453],
                         453: [387, 388, 452, 454],
                         454: [388, 389, 453, 455, 493],
                         455: [389, 390, 454, 456, 493, 494],
                         456: [390, 391, 455, 457, 494, 495],
                         457: [391, 392, 456, 458, 495, 496],
                         458: [392, 393, 457, 459, 496, 497],
                         459: [393, 394, 458, 460, 497, 498],
                         460: [394, 395, 459, 461, 498],
                         461: [395, 396, 460, 462],
                         462: [331, 396, 461],
                         463: [399, 400, 464],
                         464: [400, 401, 463, 465],
                         465: [401, 402, 464, 466],
                         466: [402, 403, 465, 467],
                         467: [403, 404, 466, 468],
                         468: [404, 405, 467],
                         469: [410, 411, 470],
                         470: [411, 412, 469, 471],
                         471: [412, 413, 470, 472],
                         472: [413, 414, 471, 473],
                         473: [414, 415, 472, 474],
                         474: [415, 416, 473],
                         475: [421, 422, 476],
                         476: [422, 423, 475, 477],
                         477: [423, 424, 476, 478],
                         478: [424, 425, 477, 479],
                         479: [425, 426, 478, 480],
                         480: [426, 427, 479],
                         481: [432, 433, 482],
                         482: [433, 434, 481, 483],
                         483: [434, 435, 482, 484],
                         484: [435, 436, 483, 485],
                         485: [436, 437, 484, 486],
                         486: [437, 438, 485],
                         487: [443, 444, 488],
                         488: [444, 445, 487, 489],
                         489: [445, 446, 488, 490],
                         490: [446, 447, 489, 491],
                         491: [447, 448, 490, 492],
                         492: [448, 449, 491],
                         493: [454, 455, 494],
                         494: [455, 456, 493, 495],
                         495: [456, 457, 494, 496],
                         496: [457, 458, 495, 497],
                         497: [458, 459, 496, 498],
                         498: [459, 460, 497]}
        evt_count = 0

        ##### This block need to be changed drastically #####
        logger.debug("Start loading file ...")
        simTree = self.__root_file__.loadTheSimulationEventTree()
        #elist = self.__get_matched_SimEvtList__(simTree,calibTree,evtlist)



        #calibEvtData = ROOT.VACalibratedArrayEvent()
        #calibTree.SetBranchAddress("C", calibEvtData)
        # Build index
        if(simTree != None):        
            simTree.BuildIndex("Sim.fRunNum","Sim.fArrayEventNum")
            #simData = ROOT.VASimulationData()
            #simTree.SetBranchAddress("Sim",simData)    
            index = simTree.GetTreeIndex()
        else:
            simData = None
        ######################################################
    
        #for evt in evtlist:
        for i in range(calibTree.GetEntries()): 
            calibTree.GetEntry(i)
            calibEvtData = calibTree.C
            logger.debug("At evt {:d}".format(i))            
            if(simTree != None):
                try:
                    simTree.GetEntryWithIndex(calibEvtData.fRunNum,calibEvtData.fArrayEventNum)
                    simData      = simTree.Sim 
                except:
                    logger.error("Can't get simulation data number {:d}".format(evt))
                    raise

            #evtNum.append(int(calibEvtData.fArrayEventNum))
            try: 
    
                snrStorage = np.zeros(500)
                for telID in tels:
                     
                    snrStorage.fill(0.0)
                    brd_candidate_index = np.array([],dtype=int)
                    try:
                        fChanData = calibEvtData.fTelEvents.at(telID).fChanData
                    except:
                        logger.debug('Cannot load data from Tel: {:d}'.format(telID))
                        continue
                    fChanData_iter = ( fChanData.at(i) for i in range(fChanData.size() )) 
                    # Save Charge to numpy array
                    for CD in fChanData_iter :
                      chanID = CD.fChanID
                      charge = CD.fCharge
                      SNR    = CD.fCharge/CD.fPedVar
                      TZero  = CD.fTZero

                      allCharge[telID][chanID] = charge 
                      allTZero[telID][chanID]  = TZero
                      snrStorage[chanID] = SNR
                      if cleaning is not None:
                        if SNR < cleaning['brd']:
                          allCharge[telID][chanID] = 0
                        elif SNR < cleaning['img']:
                          brd_candidate_index = np.append(brd_candidate_index,chanID)     
                    if cleaning is not None:
                      for chanID in brd_candidate_index:
                        passed  = False
                        for neighbor in neighbor_dict[chanID]:
                           if snrStorage[neighbor] > cleaning['img']:
                             passed = True
                             break
                        if not passed:
                          allCharge[telID][chanID] = 0  
                          allTZero[telID][chanID]  = -1
      
                    # Average over neighboring pixels for L2-masked pixels
                    if maskL2:
                      for l2chan in l2channels[telID]: 
                          if (l2chan != 499):  
                             allCharge[telID][l2chan] = np.mean(allCharge[telID,neighbor_dict[l2chan]])
                evtNums = calibEvtData.fArrayEventNum
                triggeredTels = self.__get_triggered_tel__(calibEvtData.fL2TriggeredTels)
                yield evtNums,simData,allCharge,allTZero,triggeredTels
                evt_count += 1 
            except Exception as e:
                logger.debug('Something wrong with event: {}'.format(i))
                raise e
                pass



